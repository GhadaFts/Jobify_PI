<div class="chart-container">
  <div *ngIf="funnelData$ | async as response" class="chart-wrapper">
    <h3 class="chart-title">Application Funnel</h3>
    <div class="funnel-chart">
      <!-- Views -->
      <div class="funnel-stage">
        <div class="funnel-bar" [style.width]="'100%'">
          <div class="bar-content">
            <span class="stage-label">
              <svg class="stage-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
              </svg>
              Page Views
            </span>
            <span class="stage-value">{{ response.data.views }}</span>
          </div>
        </div>
        <div class="funnel-rate">100%</div>
      </div>

      <!-- Apply Clicks -->
      <div class="funnel-stage">
        <div
          class="funnel-bar"
          [style.width]="(response.data.applyClicks / response.data.views * 100) + '%'">
          <div class="bar-content">
            <span class="stage-label">
              <svg class="stage-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 13h2v8H3zm4-8h2v16H7zm4-2h2v18h-2zm4-2h2v20h-2zm4 4h2v16h-2z"/>
              </svg>
              Apply Clicks
            </span>
            <span class="stage-value">{{ response.data.applyClicks }}</span>
          </div>
        </div>
        <div class="funnel-rate">{{ calculateConversionRate(response.data.applyClicks, response.data.views) }}%</div>
      </div>

      <!-- Applications -->
      <div class="funnel-stage">
        <div
          class="funnel-bar"
          [style.width]="(response.data.applications / response.data.views * 100) + '%'">
          <div class="bar-content">
            <span class="stage-label">
              <svg class="stage-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-8-6z M16 18H8v-2h8v2z M16 14H8v-2h8v2z M14 9H8V7h6v2z"/>
              </svg>
              Applications Submitted
            </span>
            <span class="stage-value">{{ response.data.applications }}</span>
          </div>
        </div>
        <div class="funnel-rate">{{ calculateConversionRate(response.data.applications, response.data.views) }}%</div>
      </div>

      <!-- Interviews -->
      <div class="funnel-stage">
        <div
          class="funnel-bar"
          [style.width]="(response.data.interviews / response.data.views * 100) + '%'">
          <div class="bar-content">
            <span class="stage-label">
              <svg class="stage-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 6h-2.15l.5-1.65c.3-.9-.6-1.65-1.4-1.35l-3.2 1.05c.9-1.05 2.15-1.75 3.55-1.75 2.75 0 5 2.25 5 5 0 .55-.1 1.05-.25 1.55l-3.5.65z M17.08 9.5c.33 0 .62.04.88.1l1.27-2.5c.15-.3.1-.65-.15-.85l-3.2-1.05c-.4-.15-.75.15-.8.55l-.3 1.35c1.1.35 2 1.1 2.5 2.1.15.35.5.3 1-.15z M17 13c1.66 0 2.99-1.34 2.99-3s-1.33-3-2.99-3c-1.66 0-3 1.34-3 3s1.34 3 3 3z M13 5.5c1.11 0 2-1.34 2-3s-.89-3-2-3-2 1.34-2 3 .89 3 2 3z M12 14c-1.66 0-5 .84-5 2.5V19h10v-2.5c0-1.66-3.34-2.5-5-2.5z"/>
              </svg>
              Interviews Scheduled
            </span>
            <span class="stage-value">{{ response.data.interviews }}</span>
          </div>
        </div>
        <div class="funnel-rate">{{ calculateConversionRate(response.data.interviews, response.data.views) }}%</div>
      </div>

      <!-- Hires -->
      <div class="funnel-stage">
        <div class="funnel-bar" [style.width]="(response.data.hires / response.data.views * 100) + '%'">
          <div class="bar-content">
            <span class="stage-label">
              <svg class="stage-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
              </svg>
              Offers Accepted
            </span>
            <span class="stage-value">{{ response.data.hires }}</span>
          </div>
        </div>
        <div class="funnel-rate">{{ calculateConversionRate(response.data.hires, response.data.views) }}%</div>
      </div>
    </div>

    <div class="funnel-stats">
      <div class="stat-item">
        <span class="stat-label">Overall Conversion</span>
        <span class="stat-value">{{ calculateConversionRate(response.data.hires, response.data.views) }}%</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Dropoff Rate</span>
        <span class="stat-value">{{ (100 - calculateConversionRate(response.data.hires, response.data.views)).toFixed(1) }}%</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Total Funnel Volume</span>
        <span class="stat-value">{{ response.data.views + response.data.applyClicks + response.data.applications + response.data.interviews + response.data.hires | number }}</span>
      </div>
    </div>
  </div>
</div>
